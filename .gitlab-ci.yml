# =============================================================================
# ArtisanPack UI Package CI/CD Pipeline
# =============================================================================
# This pipeline provides a robust foundation for Laravel/PHP packages.
#
# Customization:
# - SAST: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# - Secret Detection: https://docs.gitlab.com/ee/user/application_security/secret_detection/pipeline/#customization
# - Variables: https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
# =============================================================================

# -----------------------------------------------------------------------------
# Variables - Customize these for your package
# -----------------------------------------------------------------------------
variables:
  PHP_VERSION: "8.4"
  COMPOSER_HOME: /tmp/composer

# -----------------------------------------------------------------------------
# Workflow - Control when pipelines run
# -----------------------------------------------------------------------------
workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# -----------------------------------------------------------------------------
# Stages
# -----------------------------------------------------------------------------
stages:
  - build
  - test
  - code-style
  - release

# -----------------------------------------------------------------------------
# Security Scanning Templates
# -----------------------------------------------------------------------------
include:
  - template: Security/SAST.gitlab-ci.yml

sast:
  stage: test

# -----------------------------------------------------------------------------
# Hidden Jobs (YAML Anchors for Reuse)
# -----------------------------------------------------------------------------

# Base PHP setup - extend this for jobs needing PHP
.php-setup:
  image: php:${PHP_VERSION}
  before_script:
    - apt-get update -yqq
    - apt-get install -yqq git unzip libzip-dev libsqlite3-dev
    - docker-php-ext-install zip pdo_sqlite
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer config --global gitlab-token.gitlab.com ${CI_JOB_TOKEN}

# Cache configuration for Composer dependencies
.composer-cache:
  cache:
    key:
      files:
        - composer.lock
      prefix: v1-${PHP_VERSION}
    policy: pull
    paths:
      - vendor/

# =============================================================================
# BUILD STAGE
# =============================================================================

build:vendors:
  extends:
    - .php-setup
  stage: build
  cache:
    key:
      files:
        - composer.lock
      prefix: v1-${PHP_VERSION}
    policy: pull-push
    paths:
      - vendor/
  artifacts:
    paths:
      - vendor/
    expire_in: 1 hour
  script:
    - composer install --no-interaction --prefer-dist --optimize-autoloader
  interruptible: true

# =============================================================================
# TEST STAGE
# =============================================================================

tests:
  extends:
    - .php-setup
    - .composer-cache
  stage: test
  needs:
    - job: build:vendors
      artifacts: true
  script:
    - ./vendor/bin/pest --ci
  interruptible: true

# =============================================================================
# CODE STYLE STAGE
# =============================================================================

pint:
  stage: code-style
  image: php:${PHP_VERSION}
  needs:
    - job: build:vendors
      artifacts: true
  cache:
    key:
      files:
        - composer.lock
      prefix: v1-${PHP_VERSION}
    policy: pull
    paths:
      - vendor/
  script:
    - ./vendor/bin/pint --test
  allow_failure: true
  interruptible: true

# Uncomment to enable PHPCS with ArtisanPackUIStandard
# phpcs:
#   stage: code-style
#   image: php:${PHP_VERSION}
#   needs:
#     - job: build:vendors
#       artifacts: true
#   cache:
#     key:
#       files:
#         - composer.lock
#       prefix: v1-${PHP_VERSION}
#     policy: pull
#     paths:
#       - vendor/
#   script:
#     - ./vendor/bin/phpcs --standard=ArtisanPackUIStandard src
#   allow_failure: true
#   interruptible: true

# Uncomment to enable PHPStan static analysis
# phpstan:
#   stage: code-style
#   image: php:${PHP_VERSION}
#   needs:
#     - job: build:vendors
#       artifacts: true
#   cache:
#     key:
#       files:
#         - composer.lock
#       prefix: v1-${PHP_VERSION}
#     policy: pull
#     paths:
#       - vendor/
#   script:
#     - ./vendor/bin/phpstan analyse src --level=8 --no-progress
#   allow_failure: true
#   interruptible: true

# =============================================================================
# RELEASE STAGE
# =============================================================================

# Extract release notes from CHANGELOG.md
prepare_release_description:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache grep sed bash
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
      set -euxo pipefail

      echo "--- Preparing Release Description ---"
      echo "CI_COMMIT_TAG: ${CI_COMMIT_TAG}"

      if [ ! -f "CHANGELOG.md" ]; then
        echo "Warning: CHANGELOG.md not found. Using default description."
        RELEASE_DESCRIPTION_FINAL="Release ${CI_COMMIT_TAG}. No CHANGELOG.md found."
      else
        # Extract version number from tag (v1.2.3 -> 1.2.3)
        RELEASE_VERSION=$(echo "${CI_COMMIT_TAG}" | sed 's/^v//')
        echo "Extracted RELEASE_VERSION: ${RELEASE_VERSION}"

        # Extract changelog section for this version
        START_MARKER="## \\[${RELEASE_VERSION}\\]"
        END_MARKER="## \\[[0-9]*\\.[0-9]*\\.[0-9]*\\]"

        CHANGELOG_CONTENT=$(sed -n "/${START_MARKER}/,/${END_MARKER}/p" CHANGELOG.md)

        if [ -z "${CHANGELOG_CONTENT}" ]; then
          TEMP_DESCRIPTION=""
        else
          TEMP_DESCRIPTION=$(echo "${CHANGELOG_CONTENT}" | \
            grep -v "${START_MARKER}" | \
            grep -v "${END_MARKER}" | \
            grep -v "^# Changelog" | \
            sed -e 's/^[[:space:]]*//' -e '/^$/d')
        fi

        if [ -z "${TEMP_DESCRIPTION}" ] || [ "${TEMP_DESCRIPTION}" = " " ]; then
          RELEASE_DESCRIPTION_FINAL="Release ${CI_COMMIT_TAG}. Refer to CHANGELOG.md for detailed changes."
        else
          RELEASE_DESCRIPTION_FINAL="${TEMP_DESCRIPTION}"
        fi
      fi

      echo "--- Release Description ---"
      echo "${RELEASE_DESCRIPTION_FINAL}"

      # Escape newlines for dotenv file
      ESCAPED_RELEASE_DESCRIPTION=$(echo "${RELEASE_DESCRIPTION_FINAL}" | sed -E ':a;N;s/\n/\\n/g;ta')
      echo "RELEASE_DESCRIPTION=${ESCAPED_RELEASE_DESCRIPTION}" > release.env
  artifacts:
    reports:
      dotenv: release.env

# Create GitLab Release
create_actual_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: prepare_release_description
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
      set -euxo pipefail
      echo "--- Creating GitLab Release ---"
      echo "CI_COMMIT_TAG: ${CI_COMMIT_TAG}"
      release-cli create \
        --name "Release ${CI_COMMIT_TAG}" \
        --tag-name "${CI_COMMIT_TAG}" \
        --description "${RELEASE_DESCRIPTION}"
      echo "Release created successfully."
